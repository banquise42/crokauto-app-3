<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CrokAuto</title>

<link rel="icon" href="/icon.png">

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:-apple-system,Arial}
.top{position:sticky;top:0;background:#ff7a00;color:#000;padding:12px;text-align:center;font-weight:bold;font-size:20px}
.wrap{max-width:520px;margin:auto;padding:10px}
.card{background:#151515;border-radius:18px;padding:15px;margin-top:10px}
.label{color:#aaa;font-size:13px}
.value{font-size:28px;font-weight:bold}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{border:none;border-radius:16px;padding:16px;font-size:18px;font-weight:bold;cursor:pointer}
.green{background:#2DF006;color:#000}
.red{background:#c0392b;color:#fff}
.orange{background:#ff7a00;color:#000}
.blue{background:#2980b9;color:#fff}
.purple{background:#C472CC;color:#000}
.gold{background:#FFD700;color:#000}
.gray{background:#333;color:#fff}
.hidden{display:none !important}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot.on{background:#2DF006}
.small{font-size:13px;color:#aaa;margin-top:6px}
 input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:18px;
  margin-top:6px;
}
 
</style>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body>

<div class="top">üêæ CrokAuto üêæ</div>

<div class="wrap">

<div class="card">
<div class="label">√âtat</div>
<div class="value" id="status">---</div>

<div class="label">Poids r√©serve</div>
<div class="value"><span id="weight">0</span> g</div>

<div class="label">Ration cible</div>
<div class="value"><span id="target">0</span> g</div>
</div>

<div class="card">
<button class="btn blue" onclick="toggleAuto()" style="width:100%">
<span id="autoDot" class="dot"></span>
ü§ñ Distribution Auto
</button>
</div>

<div class="card grid">
<button class="btn green" onclick="cmd('dist')">üçΩ Distribution</button>
<button class="btn red" onclick="cmd('stop')">‚õî STOP</button>
<button class="btn purple" onclick="cmd('vid')">üßπ Vidange</button>
<button class="btn gold" onclick="toggleLamp()">
<span id="lampDot" class="dot"></span>üí° Lampe
</button>
</div>

<div class="card">
<div class="label">D√©finir poids de la ration</div>

<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
  <input id="setg" type="number"
  style="width:70px;text-align:center"
  onfocus="editingRation=true"
  onblur="editingRation=false">
  <div class="small">grammes</div>
</div>

<button class="btn green" onclick="setRation()" style="width:100%">
Valider
</button>
</div>


<script>
const deviceID="crokauto_001";
const client=mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
  
let editingRation = false;
let mqttReady=false;
let lastStatus=null;

client.on("connect",()=>{
mqttReady=true;
client.subscribe("crok/"+deviceID+"/status");
});

client.on("message",(topic,payload)=>{
if(topic.endsWith("/status"))
lastStatus=JSON.parse(payload.toString());
});

function send(cmd){
if(!mqttReady) return;
client.publish("crok/"+deviceID+"/cmd",cmd);
}

function cmd(c){send(c);}
function toggleLamp(){send("lamp");}
function toggleAuto(){send("auto");}
function setRation(){
  const input = document.getElementById("setg");
  const g = parseFloat(input.value);

  if(isNaN(g) || g <= 0) return;

  send("set:"+g);
  editingRation = false;
  input.blur();
}

setInterval(()=>{
if(!lastStatus) return;

document.getElementById("status").innerText = lastStatus.state;
document.getElementById("weight").innerText = lastStatus.weight.toFixed(1);
document.getElementById("target").innerText = lastStatus.target.toFixed(1);
if(!editingRation){
document.getElementById("setg").value = lastStatus.target;
}
document.getElementById("lampDot")
.classList.toggle("on", lastStatus.lamp==="ON");
document.getElementById("autoDot").style.background =
(lastStatus.auto==="ON") ? "#2DF006" : "#c0392b";

},1000);
</script>

</body>
</html>
