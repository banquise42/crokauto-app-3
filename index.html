<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CrokAuto</title>

<link rel="icon" href="/icon.png">

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:-apple-system,Arial}
.top{position:sticky;top:0;background:#ff7a00;color:#000;padding:12px;text-align:center;font-weight:bold;font-size:20px;box-shadow:0 5px 15px rgba(0,0,0,.5)}
.wrap{max-width:520px;margin:auto;padding:10px}
.card{background:#151515;border-radius:18px;padding:15px;margin-top:10px;box-shadow:0 10px 25px rgba(0,0,0,.5)}
.label{color:#aaa;font-size:13px}
.value{font-size:28px;font-weight:bold}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{border:none;border-radius:16px;padding:16px;font-size:18px;font-weight:bold;cursor:pointer}
.green{background:#2DF006;color:#000}
.red{background:#c0392b;color:#fff}
.orange{background:#ff7a00;color:#000}
.blue{background:#2980b9;color:#fff}
.purple{background:#C472CC;color:#000}
.gold{background:#FFD700;color:#000}
.gray{background:#333;color:#fff}
.tabs{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
.tab{height:42px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:#222;font-weight:bold;cursor:pointer;font-size:14px}
.tab.active{background:#ff7a00;color:#000}
.hidden{display:none !important}
input{width:100%;padding:12px;border-radius:12px;border:none;font-size:18px;margin-top:6px}
.small{font-size:13px;color:#aaa;margin-top:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:transparent}
.dot.on{background:#2DF006}
</style>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body>

<div class="top">ğŸ¾ CrokAuto ğŸ¾</div>

<div class="wrap">

<div class="tabs">
<div id="tabHome" class="tab active" onclick="showTab('home')">ğŸ  Accueil</div>
<div id="tabSettings" class="tab" onclick="showTab('settings')">âš™ï¸ ParamÃ¨tres</div>
</div>

<!-- ================= ACCUEIL ================= -->

<div id="homePanel">

<div class="card">
<div class="label">Ã‰tat</div>
<div class="value" id="status">---</div>

<div class="label">Poids rÃ©serve</div>
<div class="value"><span id="weight">0</span> g</div>

<div class="label">Ration cible</div>
<div class="value"><span id="target">0</span> g</div>
</div>

<div class="card">
<button class="btn blue" onclick="toggleAuto()" style="width:100%">
<span id="autoDot" class="dot"></span>
ğŸ¤– Distribution Auto
</button>
</div>

<div class="card grid">
<button class="btn green" onclick="send('dist')">ğŸ½ Distribution</button>
<button class="btn red" onclick="send('stop')">â›” STOP</button>
<button class="btn purple" onclick="send('gethistory')">ğŸ“œ Historique</button>
<button class="btn gold" onclick="send('lamp')">
<span id="lampDot" class="dot"></span>ğŸ’¡ Lampe
</button>
</div>

<div class="card">
<div class="label">DÃ©finir poids de la ration</div>
<input id="setg" type="number">
<button class="btn green" onclick="send('set:'+setg.value)">Valider</button>
</div>

</div>

<!-- ================= PARAMÃˆTRES ================= -->

<div id="settingsPanel" class="hidden">

<div class="tabs">
<div id="subPlan" class="tab active" onclick="showSub('plan')">ğŸ“… Planning</div>
<div id="subLamp" class="tab" onclick="showSub('lamp')">ğŸ’¡Tempo Lampe</div>
<div id="subMail" class="tab" onclick="showSub('mail')">ğŸ’Œ Email</div>
<div id="subMaint" class="tab" onclick="showSub('maint')">ğŸ›  Maintenance</div>
</div>

<div id="panelPlan" class="card"></div>
<div id="panelLamp" class="card hidden"></div>
<div id="panelMail" class="card hidden"></div>
<div id="panelMaint" class="card hidden"></div>

</div>

</div>

<script>
const deviceID="crokauto_001";
const client=mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

let lastStatus=null;

client.on("connect",()=>{
client.subscribe("crok/"+deviceID+"/status");
});

client.on("message",(topic,payload)=>{
if(topic.endsWith("/status")){
lastStatus=JSON.parse(payload.toString());
updateUI();
}
});

function send(cmd){
client.publish("crok/"+deviceID+"/cmd",cmd);
}

function toggleAuto(){send("auto");}

function updateUI(){
if(!lastStatus) return;

status.innerText=lastStatus.state;
weight.innerText=lastStatus.weight.toFixed(1);
target.innerText=lastStatus.target.toFixed(1);

lampDot.classList.toggle("on",lastStatus.lamp==="ON");
autoDot.style.background=(lastStatus.auto==="ON")?"#2DF006":"#c0392b";
}

function showTab(t){
homePanel.classList.toggle("hidden",t!=='home');
settingsPanel.classList.toggle("hidden",t!=='settings');
tabHome.classList.toggle("active",t==='home');
tabSettings.classList.toggle("active",t==='settings');
}

function showSub(s){
['plan','lamp','mail','maint'].forEach(x=>{
document.getElementById('panel'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('hidden',x!==s);
document.getElementById('sub'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('active',x===s);
});
}
</script>

</body>
</html>
